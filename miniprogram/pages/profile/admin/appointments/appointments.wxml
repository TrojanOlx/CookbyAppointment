<view class="container" style="padding-bottom: {{safeAreaBottom ? (safeAreaBottom + 48 + 'px') : '120rpx'}};">
  <!-- æ—¥å†éƒ¨åˆ† -->
  <view class="calendar-section">
    <calendar 
      id="calendar"
      view="week"
      mode="{{calendarMode}}"
      date="{{selectedDate}}"
      marks="{{markedDates}}"
      lunar="{{true}}"
      plugins="{{plugins}}"
      header="{{true}}"
      fold="{{false}}"
      bindload="onCalendarLoad"
      bindclick="onCalendarSelect"
      bindchange="onCalendarChange"
      bindviewchange="onViewChange"
    />
  </view>

  <!-- é¢„çº¦åˆ—è¡¨éƒ¨åˆ† -->
  <view class="appointments-section">
    <view class="section-header">
      <text class="section-title">{{selectedDateDisplay}}ç”¨æˆ·é¢„çº¦</text>
    </view>

    <view class="appointments-list">
      <!-- åŠ è½½çŠ¶æ€ -->
      <view class="loading-state" wx:if="{{isLoading}}">
        <view class="loading-spinner"></view>
        <text class="loading-text">åŠ è½½ä¸­...</text>
      </view>
      
      <!-- é¢„çº¦åˆ—è¡¨ -->
      <block wx:elif="{{userAppointments.length > 0}}">
        <view class="user-card" wx:for="{{userAppointments}}" wx:key="userName" wx:for-item="user" wx:for-index="userIndex">
          <view class="user-header" bindtap="toggleUserExpand" data-index="{{userIndex}}">
            <text class="user-name">{{user.userName}}</text>
            <view class="expand-icon {{user.isExpanded ? 'expanded' : ''}}">
              <text class="iconfont">{{user.isExpanded ? 'â–¼' : 'â–¶'}}</text>
            </view>
          </view>
          <view class="meals-list {{user.isExpanded ? 'expanded' : 'collapsed'}}">
            <view class="meal-item" wx:for="{{user.meals}}" wx:key="type" wx:for-item="meal">
              <view class="meal-type-wrapper">
                <view class="meal-type">
                  <text class="meal-icon" wx:if="{{meal.type === 'æ—©é¤'}}">ğŸŒ…</text>
                  <text class="meal-icon" wx:elif="{{meal.type === 'åˆé¤'}}">â˜€ï¸</text>
                  <text class="meal-icon" wx:elif="{{meal.type === 'æ™šé¤'}}">ğŸŒ™</text>
                  {{meal.type}}
                </view>
                <view class="meal-status status-{{meal.status === 'å¾…ç¡®è®¤' ? 'pending' : meal.status === 'å·²ç¡®è®¤' ? 'confirmed' : meal.status === 'å·²å®Œæˆ' ? 'completed' : 'cancelled'}}">{{meal.status || 'å¾…ç¡®è®¤'}}</view>
              </view>
              <view class="dish-list">
                <text class="dish-name" wx:for="{{meal.dishes}}" wx:key="*this" wx:for-item="dish">{{dish}}</text>
              </view>
              
              <!-- æ ¹æ®çŠ¶æ€æ˜¾ç¤ºä¸åŒæŒ‰é’® -->
              <view class="action-buttons" wx:if="{{meal.status !== 'å·²å–æ¶ˆ'}}">
                <!-- å¾…ç¡®è®¤çŠ¶æ€æŒ‰é’® -->
                <block wx:if="{{meal.status === 'å¾…ç¡®è®¤'}}">
                  <view class="action-btn confirm-btn" bindtap="confirmAppointment" data-appointment-id="{{meal.id}}">ç¡®è®¤é¢„çº¦</view>
                  <view class="action-btn cancel-btn" bindtap="cancelAppointment" data-appointment-id="{{meal.id}}">å–æ¶ˆé¢„çº¦</view>
                </block>
                
                <!-- å·²ç¡®è®¤çŠ¶æ€æŒ‰é’® -->
                <block wx:elif="{{meal.status === 'å·²ç¡®è®¤'}}">
                  <view class="action-btn complete-btn" bindtap="completeAppointment" data-appointment-id="{{meal.id}}">å·²å®Œæˆ</view>
                  <view class="action-btn cancel-btn" bindtap="cancelAppointment" data-appointment-id="{{meal.id}}">å–æ¶ˆé¢„çº¦</view>
                </block>
                
                <!-- å·²å®ŒæˆçŠ¶æ€æŒ‰é’® -->
                <block wx:elif="{{meal.status === 'å·²å®Œæˆ'}}">
                  <view class="action-btn review-btn" bindtap="viewReview" data-appointment-id="{{meal.id}}" data-user-name="{{user.userName}}">æŸ¥çœ‹è¯„ä»·</view>
                </block>
              </view>
            </view>
          </view>
        </view>
      </block>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:else>
        <text class="empty-text">æš‚æ— é¢„çº¦å®‰æ’</text>
      </view>
    </view>
  </view>
</view> 